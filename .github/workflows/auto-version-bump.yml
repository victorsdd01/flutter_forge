name: Auto Version Bump

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write

jobs:
  bump-version:
    if: |
      github.event.pull_request.merged == true &&
      !contains(github.event.pull_request.title, '[skip ci]') &&
      !contains(github.event.pull_request.title, 'chore: bump version')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          persist-credentials: true

      - name: Get current version (for release)
        id: current_version
        run: |
          CURRENT_VERSION=$(grep "version:" pubspec.yaml | cut -d " " -f 2 | tr -d '\r')
          echo "Current version (for release): $CURRENT_VERSION"
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

      - name: Get PR information
        id: pr_info
        run: |
          set -e
          
          # Get PR title and body, handling special characters safely
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_BODY="${{ github.event.pull_request.body }}"
          
          # Sanitize variables - remove carriage returns
          PR_TITLE=$(echo "${PR_TITLE}" | tr -d '\r' || echo "")
          PR_BODY=$(echo "${PR_BODY}" | tr -d '\r' || echo "")
          
          echo "PR Title: ${PR_TITLE}"
          
          # Use delimiter to handle multiline content safely
          {
            echo "pr_title<<EOF"
            echo "${PR_TITLE}"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          {
            echo "pr_body<<EOF"
            echo "${PR_BODY}"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Extract release notes from CHANGELOG (current version)
        id: release_notes
        run: |
          VERSION="${{ steps.current_version.outputs.version }}"
          # Extract the changelog entry for current version
          RELEASE_NOTES=$(awk "/^## \[$VERSION\]/,/^## \[/" CHANGELOG.md | sed '/^## \[/d' | sed '/^$/d' | head -n 20)
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE_NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Git tag (current version)
        run: |
          VERSION="${{ steps.current_version.outputs.version }}"
          git tag -a "v$VERSION" -m "Release v$VERSION"
          git push origin "v$VERSION"
          echo "âœ… Created and pushed tag v$VERSION"

      - name: Create GitHub Release (current version)
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.current_version.outputs.version }}
          name: FlutterForge CLI v${{ steps.current_version.outputs.version }}
          body: |
            ## ðŸš€ What's New in v${{ steps.current_version.outputs.version }}
            
            ${{ steps.release_notes.outputs.notes }}
            
            ---
            
            ### ðŸ“¦ Installation
            
            ```bash
            dart pub global activate --source git https://github.com/victorsdd01/flutter_forge.git
            ```
            
            ### ðŸ”„ Update
            
            ```bash
            flutterforge --update
            ```
            
            ### ðŸ“š Full Changelog
            
            See [CHANGELOG.md](https://github.com/victorsdd01/flutter_forge/blob/main/CHANGELOG.md) for the complete list of changes.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Calculate new version
        id: new_version
        run: |
          CURRENT_VERSION="${{ steps.current_version.outputs.version }}"
          
          # Parse version parts (ej: "1.10.0" -> "1", "10", "0")
          MAJOR=$(echo $CURRENT_VERSION | cut -d '.' -f 1)
          MINOR=$(echo $CURRENT_VERSION | cut -d '.' -f 2)
          PATCH=$(echo $CURRENT_VERSION | cut -d '.' -f 3)
          
          # Increment patch version (1.10.0 -> 1.10.1)
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
          
          echo "New version: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Update pubspec.yaml
        run: |
          sed -i "s/version:.*/version: ${{ steps.new_version.outputs.version }}/" pubspec.yaml
          echo "Updated pubspec.yaml:"
          grep "version:" pubspec.yaml

      - name: Update CHANGELOG.md
        run: |
          VERSION="${{ steps.new_version.outputs.version }}"
          PR_TITLE="${{ steps.pr_info.outputs.pr_title }}"
          PR_BODY="${{ steps.pr_info.outputs.pr_body }}"
          DATE=$(date +%Y-%m-%d)
          
          # Clean PR title (remove version tags like [MINOR], [MAJOR], etc.)
          CLEAN_TITLE=$(echo "$PR_TITLE" | sed 's/\[MINOR\]//g' | sed 's/\[MAJOR\]//g' | sed 's/\[PATCH\]//g' | sed 's/\[SKIP\]//g' | xargs)
          
          # Extract changelog content from PR body if it exists
          CHANGELOG_CONTENT=""
          if echo "$PR_BODY" | grep -qiE "## (Changelog|What's New|Changes)"; then
            # Extract content between ## Changelog/What's New/Changes and next ##
            CHANGELOG_CONTENT=$(echo "$PR_BODY" | sed -n '/## [Cc]hangelog\|## [Ww]hat'\''s [Nn]ew\|## [Cc]hanges/I,/^##/p' | sed '/^##/d' | sed '/^$/d' | head -n 10)
          fi
          
          # If no changelog content found, use PR title
          if [ -z "$CHANGELOG_CONTENT" ] || [ "$CHANGELOG_CONTENT" = "" ]; then
            CHANGELOG_CONTENT="- $CLEAN_TITLE"
          else
            # Format the content properly (ensure each line starts with -)
            CHANGELOG_CONTENT=$(echo "$CHANGELOG_CONTENT" | sed 's/^/- /' | sed 's/^- -/-/')
          fi
          
          # Create Python script file
          cat > /tmp/update_changelog.py << 'PYEOF'
          import re
          import os
          
          version = os.environ.get('VERSION', '')
          date = os.environ.get('DATE', '')
          changelog_content = os.environ.get('CHANGELOG_CONTENT', '')
          
          # Create new changelog entry
          new_entry = f"""## [{version}] - {date}
          
          ### Changes
          {changelog_content}
          
          """
          
          # Read current CHANGELOG
          with open('CHANGELOG.md', 'r', encoding='utf-8') as f:
              content = f.read()
          
          # Find [Unreleased] section and insert after it
          if '## [Unreleased]' in content:
              # Find the end of [Unreleased] section (after the last item before next ##)
              pattern = r'(## \[Unreleased\].*?\n\n)'
              match = re.search(pattern, content, re.DOTALL)
              if match:
                  # Insert new version after [Unreleased] section
                  insert_pos = match.end()
                  content = content[:insert_pos] + new_entry + content[insert_pos:]
              else:
                  # Fallback: insert after [Unreleased] line
                  content = content.replace('## [Unreleased]', f'## [Unreleased]\n\n{new_entry}', 1)
          else:
              # Insert after header (after line 7)
              lines = content.split('\n')
              lines.insert(8, new_entry.strip())
              content = '\n'.join(lines)
          
          # Write updated content
          with open('CHANGELOG.md', 'w', encoding='utf-8') as f:
              f.write(content)
          
          print(f"âœ… Updated CHANGELOG.md with version {version}")
          PYEOF
          
          # Execute Python script with environment variables
          export VERSION="${{ steps.new_version.outputs.version }}"
          export DATE="$DATE"
          export CHANGELOG_CONTENT="$CHANGELOG_CONTENT"
          python3 /tmp/update_changelog.py
          
          echo ""
          echo "ðŸ“‹ New changelog entry preview:"
          head -n 25 CHANGELOG.md

      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Commit and push version bump to main
        run: |
          git checkout main
          git pull origin main
          
          git add pubspec.yaml CHANGELOG.md
          git commit -m "chore: bump version to ${{ steps.new_version.outputs.version }} [skip ci]"
          
          # Push to main
          git push origin main
          
          echo "âœ… Version bumped to ${{ steps.new_version.outputs.version }} and pushed to main"
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
